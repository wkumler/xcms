<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Merge neighboring and overlapping chromatographic peaks — MergeNeighboringPeaksParam • xcms</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Merge neighboring and overlapping chromatographic peaks — MergeNeighboringPeaksParam" />
<meta property="og:description" content="Peak detection sometimes fails to identify a chromatographic peak correctly,
especially for broad peaks and if the peak shape is irregular (mostly for
HILIC data). In such cases several smaller peaks are reported. Also, peak
detection can result in partially or completely overlapping peaks. To reduce
such peak detection artifacts, this function merges chromatographic peaks
which are overlapping or close in rt and m/z dimension considering also the
measured signal intensities in the region between them.
Chromatographic peaks are first expanded in m/z and retention time dimension
(based on parameters expandMz, ppm and expandRt) and subsequently
grouped into sets of merge candidates if they are (after expansion)
overlapping in both m/z and rt (within the same sample).
Candidate peaks are merged if the average intensity of the 3 data
points in the middle position between them (i.e. at half the distance between
&quot;rtmax&quot; of the first and &quot;rtmin&quot; of the second peak) is larger than a
certain proportion (minProp) of the smaller maximal intensity (&quot;maxo&quot;)
of both peaks. In cases in which this calculated mid point is not
located between the apexes of the two peaks (e.g. if the peaks are largely
overlapping) the average signal intensity at half way between the apexes is
used instead. Candidate peaks are not joined if all 3 data points between
them have NA intensities.
The joined peaks get the &quot;mz&quot;, &quot;rt&quot;, &quot;sn&quot; and &quot;maxo&quot; values from
the peak with the largest signal (&quot;maxo&quot;) as well as its row in the
metadata data frame of the peak (chromPeakData). The &quot;rtmin&quot;, &quot;rtmax&quot;
of the merged peaks are updated and &quot;into&quot; is recalculated based on all
the signal between &quot;rtmin&quot; and &quot;rtmax&quot; of the new merged peak. See
details for information on the &quot;mzmin&quot; and &quot;mzmax&quot; values of the merged
peak." />






<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  

  

  </head>

  <body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">xcms</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">3.13.5</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../articles/xcms.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/xcms-direct-injection.html">Grouping FTICR-MS data with xcms</a>
    </li>
    <li>
      <a href="../articles/xcms-lcms-ms.html">LC-MS/MS data analysis with xcms</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/sneumann/xcms/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Merge neighboring and overlapping chromatographic peaks</h1>
    <small class="dont-index">Source: <a href='https://github.com/sneumann/xcms/blob/master/R/functions-Params.R'><code>R/functions-Params.R</code></a>, <a href='https://github.com/sneumann/xcms/blob/master/R/methods-XCMSnExp.R'><code>R/methods-XCMSnExp.R</code></a></small>
    <div class="hidden name"><code>refineChromPeaks-merge.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Peak detection sometimes fails to identify a chromatographic peak correctly,
especially for broad peaks and if the peak shape is irregular (mostly for
HILIC data). In such cases several smaller peaks are reported. Also, peak
detection can result in partially or completely overlapping peaks. To reduce
such peak detection artifacts, this function merges chromatographic peaks
which are overlapping or close in rt and m/z dimension considering also the
measured signal intensities in the region between them.</p>
<p>Chromatographic peaks are first expanded in m/z and retention time dimension
(based on parameters <code>expandMz</code>, <code>ppm</code> and <code>expandRt</code>) and subsequently
grouped into sets of merge candidates if they are (after expansion)
overlapping in both m/z and rt (within the same sample).
Candidate peaks are merged if the average intensity of the 3 data
points in the middle position between them (i.e. at half the distance between
<code>"rtmax"</code> of the first and <code>"rtmin"</code> of the second peak) is larger than a
certain proportion (<code>minProp</code>) of the smaller maximal intensity (<code>"maxo"</code>)
of both peaks. In cases in which this calculated mid point is <strong>not</strong>
located between the apexes of the two peaks (e.g. if the peaks are largely
overlapping) the average signal intensity at half way between the apexes is
used instead. Candidate peaks are not joined if all 3 data points between
them have <code>NA</code> intensities.
The joined peaks get the <code>"mz"</code>, <code>"rt"</code>, <code>"sn"</code> and <code>"maxo"</code> values from
the peak with the largest signal (<code>"maxo"</code>) as well as its row in the
metadata data frame of the peak (<code>chromPeakData</code>). The <code>"rtmin"</code>, <code>"rtmax"</code>
of the merged peaks are updated and <code>"into"</code> is recalculated based on all
the signal between <code>"rtmin"</code> and <code>"rtmax"</code> of the new merged peak. See
details for information on the <code>"mzmin"</code> and <code>"mzmax"</code> values of the merged
peak.</p>
    </div>

    <pre class="usage"><span class='fu'>MergeNeighboringPeaksParam</span><span class='op'>(</span>
  expandRt <span class='op'>=</span> <span class='fl'>2</span>,
  expandMz <span class='op'>=</span> <span class='fl'>0</span>,
  ppm <span class='op'>=</span> <span class='fl'>10</span>,
  minProp <span class='op'>=</span> <span class='fl'>0.75</span>
<span class='op'>)</span>

<span class='co'># S4 method for XCMSnExp,MergeNeighboringPeaksParam</span>
<span class='fu'><a href='CleanPeaksParam.html'>refineChromPeaks</a></span><span class='op'>(</span>
  <span class='va'>object</span>,
  param <span class='op'>=</span> <span class='fu'>MergeNeighboringPeaksParam</span><span class='op'>(</span><span class='op'>)</span>,
  msLevel <span class='op'>=</span> <span class='fl'>1L</span>,
  BPPARAM <span class='op'>=</span> <span class='fu'>bpparam</span><span class='op'>(</span><span class='op'>)</span>
<span class='op'>)</span></pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>expandRt</th>
      <td><p><code><a href='https://rdrr.io/r/base/numeric.html'>numeric(1)</a></code> defining by how many seconds the retention time
window is expanded on both sides to check for overlapping peaks.</p></td>
    </tr>
    <tr>
      <th>expandMz</th>
      <td><p><code><a href='https://rdrr.io/r/base/numeric.html'>numeric(1)</a></code> constant value by which the m/z range of each
chromatographic peak is expanded (on both sides!) to check for
overlapping peaks.</p></td>
    </tr>
    <tr>
      <th>ppm</th>
      <td><p><code><a href='https://rdrr.io/r/base/numeric.html'>numeric(1)</a></code> defining a m/z relative value (in parts per million)
by which the m/z range of each chromatographic peak is expanded
to check for overlapping peaks.</p></td>
    </tr>
    <tr>
      <th>minProp</th>
      <td><p><code><a href='https://rdrr.io/r/base/numeric.html'>numeric(1)</a></code> between <code>0</code> and <code>1</code> representing the proporion
of intensity to be required for peaks to be joined. See description for
more details. The default (<code>minProp = 0.75</code>) means that peaks are only
joined if the signal half way between then is larger 75% of the smallest
of the two peak's <code>"maxo"</code> (maximal intensity at peak apex).</p></td>
    </tr>
    <tr>
      <th>object</th>
      <td><p><a href='XCMSnExp-class.html'>XCMSnExp</a> object with identified chromatographic peaks.</p></td>
    </tr>
    <tr>
      <th>param</th>
      <td><p><code>MergeNeighboringPeaksParam</code> object defining the settings for
the method.</p></td>
    </tr>
    <tr>
      <th>msLevel</th>
      <td><p><code>integer</code> defining for which MS level(s) the chromatographic
peaks should be merged.</p></td>
    </tr>
    <tr>
      <th>BPPARAM</th>
      <td><p>parameter object to set up parallel processing. Uses the
default parallel processing setup returned by <code>bpparam()</code>. See
<code>bpparam()</code> for details and examples.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p><code>XCMSnExp</code> object with chromatographic peaks matching the defined
conditions being merged.</p>
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>For each set of candidate peaks an ion chromatogram is
extracted using the range of retention times and m/z values of these peaks.
The m/z range for the extracted ion chromatogram is expanded by <code>expandMz</code>
and <code>ppm</code> (on both sides) to reduce the possibility of missing signal
intensities between candidate peaks (variance of measured m/z values for
lower intensities is larger than for higher intensities and thus data points
not being part of identified chromatographic peaks tend to have m/z values
outside of the m/z range of the candidate peaks - especially for ToF
instruments). This also ensures that all data points from the same ion are
considered for the peak integration of merged peaks. The smallest and largest
m/z value of all data points used in the peak integration of the merged peak
are used as the merged peak's m/z range (i.e. columns <code>"mzmin"</code> and <code>"mzmax"</code>).</p>
    <h2 class="hasAnchor" id="note"><a class="anchor" href="#note"></a>Note</h2>

    <p>Note that <strong>each</strong> peak gets expanded by <code>expandMz</code> and <code>expandRt</code>, thus
peaks differing by <code>2 * expandMz</code> (or <code>expandRt</code>) will be identified as
<em>overlapping</em>. As an example: m/z max of one peak is 12.2, m/z min of
another one is 12.4, if <code>expandMz = 0.1</code> the m/z max of the first peak
will be 12.3 and the m/z min of the second one 12.3, thus both are
considered overlapping.</p>
<p><code>refineChromPeaks</code> methods will always remove feature definitions, because
a call to this method can change or remove identified chromatographic peaks,
which may be part of features.</p>
<p>Merging of chromatographic peaks is performed along the retention time axis,
i.e. candidate peaks are first ordered by their <code>"rtmin"</code> value. The signals
at half way between the first and the second candidate peak are then compared
to the smallest <code>"maxo"</code> of both and the two peaks are then merged if the
average signal between the peaks is larger <code>minProp</code>. For merging any
additional peak in a candidate peak list the <code>"maxo"</code> of that peak and the
newly merged peak are considered.</p>
    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <div class='dont-index'><p>Other chromatographic peak refinement methods: 
<code><a href='CleanPeaksParam.html'>CleanPeaksParam</a></code>,
<code><a href='FilterIntensityParam.html'>FilterIntensityParam</a></code></p></div>
    <h2 class="hasAnchor" id="author"><a class="anchor" href="#author"></a>Author</h2>

    <p>Johannes Rainer, Mar Garcia-Aloy</p>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'>
<span class='co'>## Load a test data set with detected peaks</span>
<span class='fu'><a href='https://rdrr.io/r/utils/data.html'>data</a></span><span class='op'>(</span><span class='va'>faahko_sub</span><span class='op'>)</span>
<span class='co'>## Update the path to the files for the local system</span>
<span class='fu'><a href='dirname.html'>dirname</a></span><span class='op'>(</span><span class='va'>faahko_sub</span><span class='op'>)</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/system.file.html'>system.file</a></span><span class='op'>(</span><span class='st'>"cdf/KO"</span>, package <span class='op'>=</span> <span class='st'>"faahKO"</span><span class='op'>)</span>

<span class='co'>## Disable parallel processing for this example</span>
<span class='fu'>register</span><span class='op'>(</span><span class='fu'>SerialParam</span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>

<span class='co'>## Subset to a single file</span>
<span class='va'>xd</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://lgatto.github.io/MSnbase/reference/MSnExp-class.html'>filterFile</a></span><span class='op'>(</span><span class='va'>faahko_sub</span>, file <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span>

<span class='co'>## Example of a split peak that will be merged</span>
<span class='va'>mzr</span> <span class='op'>&lt;-</span> <span class='fl'>305.1</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>0.01</span>, <span class='fl'>0.01</span><span class='op'>)</span>
<span class='va'>chr</span> <span class='op'>&lt;-</span> <span class='fu'><a href='chromatogram,XCMSnExp-method.html'>chromatogram</a></span><span class='op'>(</span><span class='va'>xd</span>, mz <span class='op'>=</span> <span class='va'>mzr</span>, rt <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>2700</span>, <span class='fl'>3700</span><span class='op'>)</span><span class='op'>)</span>
<span class='fu'><a href='https://lgatto.github.io/MSnbase/reference/plot-methods.html'>plot</a></span><span class='op'>(</span><span class='va'>chr</span><span class='op'>)</span>
</div><div class='img'><img src='refineChromPeaks-merge-1.png' alt='' width='700' height='433' /></div><div class='input'>
<span class='co'>## Combine the peaks</span>
<span class='va'>res</span> <span class='op'>&lt;-</span> <span class='fu'><a href='CleanPeaksParam.html'>refineChromPeaks</a></span><span class='op'>(</span><span class='va'>xd</span>, param <span class='op'>=</span> <span class='fu'>MergeNeighboringPeaksParam</span><span class='op'>(</span>expandRt <span class='op'>=</span> <span class='fl'>4</span><span class='op'>)</span><span class='op'>)</span>
</div><div class='output co'>#&gt; <span class='message'>Evaluating 8 peaks in file ko15.CDF for merging ... </span></div><div class='output co'>#&gt; <span class='message'>OK</span></div><div class='output co'>#&gt; <span class='message'>Merging reduced 87 chromPeaks to 70.</span></div><div class='input'><span class='va'>chr_res</span> <span class='op'>&lt;-</span> <span class='fu'><a href='chromatogram,XCMSnExp-method.html'>chromatogram</a></span><span class='op'>(</span><span class='va'>res</span>, mz <span class='op'>=</span> <span class='va'>mzr</span>, rt <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>2700</span>, <span class='fl'>3700</span><span class='op'>)</span><span class='op'>)</span>
<span class='fu'><a href='https://lgatto.github.io/MSnbase/reference/plot-methods.html'>plot</a></span><span class='op'>(</span><span class='va'>chr_res</span><span class='op'>)</span>
</div><div class='img'><img src='refineChromPeaks-merge-2.png' alt='' width='700' height='433' /></div><div class='input'>
<span class='co'>## Example of a peak that was not merged, because the signal between them</span>
<span class='co'>## is lower than the cut-off minProp</span>
<span class='va'>mzr</span> <span class='op'>&lt;-</span> <span class='fl'>496.2</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>0.01</span>, <span class='fl'>0.01</span><span class='op'>)</span>
<span class='va'>chr</span> <span class='op'>&lt;-</span> <span class='fu'><a href='chromatogram,XCMSnExp-method.html'>chromatogram</a></span><span class='op'>(</span><span class='va'>xd</span>, mz <span class='op'>=</span> <span class='va'>mzr</span>, rt <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>3200</span>, <span class='fl'>3500</span><span class='op'>)</span><span class='op'>)</span>
<span class='fu'><a href='https://lgatto.github.io/MSnbase/reference/plot-methods.html'>plot</a></span><span class='op'>(</span><span class='va'>chr</span><span class='op'>)</span>
</div><div class='input'><span class='va'>chr_res</span> <span class='op'>&lt;-</span> <span class='fu'><a href='chromatogram,XCMSnExp-method.html'>chromatogram</a></span><span class='op'>(</span><span class='va'>res</span>, mz <span class='op'>=</span> <span class='va'>mzr</span>, rt <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>3200</span>, <span class='fl'>3500</span><span class='op'>)</span><span class='op'>)</span>
<span class='fu'><a href='https://lgatto.github.io/MSnbase/reference/plot-methods.html'>plot</a></span><span class='op'>(</span><span class='va'>chr_res</span><span class='op'>)</span>
</div><div class='img'><img src='refineChromPeaks-merge-3.png' alt='' width='700' height='433' /></div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p><p>Developed by Steffen Neumann.</p></p>
</div>

<div class="pkgdown">
  <p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 1.6.1.9000.</p></p>
</div>

      </footer>
   </div>

  


  

  </body>
</html>


